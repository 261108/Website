<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Cloud</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Apply Inter font and basic styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            box-sizing: border-box;
            color: #334155;
        }

        .container {
            max-width: 900px;
            width: 100%;
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.04);
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1.5rem;
        }

        .image-item {
            position: relative;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            overflow: hidden;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .image-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .image-item img {
            width: 100%;
            height: 120px;
            object-fit: contain;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .image-info {
            font-size: 0.8rem;
            color: #64748b;
            text-align: center;
            word-break: break-all;
        }
        
        .message-box {
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .message-box.info {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .message-box.success {
            background-color: #dcfce7;
            color: #15803d;
            border: 1px solid #6ee7b7;
        }
        .message-box.warning {
            background-color: #fef9c3;
            color: #a16207;
            border: 1px solid #fde047;
        }
        .message-box.error {
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fca5a5;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            background-color: #2563eb;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        
        .btn-secondary {
            background-color: #64748b;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            text-align: center;
        }

        .btn-secondary:hover {
            background-color: #475569;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }
        
        #password-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }
        
        .description-box {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 0.8rem;
            color: #475569;
            margin-top: 0.75rem;
            word-break: break-word;
        }
    </style>
</head>
<body class="p-4 bg-gray-100 flex justify-center items-center min-h-screen">
    <!-- Main container for the app's content -->
    <div id="app-container" class="container">
        
        <!-- Password Content -->
        <div id="password-content">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-6">Enter Password</h1>
            <div class="w-full max-w-sm mb-4">
                <input type="text" id="password-input" class="w-full p-4 border border-gray-300 rounded-xl text-center text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" placeholder="" maxlength="4">
            </div>
            <button id="password-submit-btn" class="btn-primary w-full max-w-sm">
                Submit
            </button>
            <div id="password-message" class="message-box mt-4 hidden" role="alert"></div>
        </div>
        
        <!-- Main App Content -->
        <div id="main-content" class="w-full hidden">
            <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-4">Free Cloud</h1>

            <!-- User Info Section -->
            <div class="bg-blue-100 border border-blue-400 text-blue-700 px-6 py-4 rounded-xl relative text-sm mb-6 shadow-sm">
                <strong class="font-bold">Your Session ID:</strong>
                <span id="user-id-display" class="block sm:inline break-all font-mono">Authenticating...</span>
            </div>

            <!-- Upload Section -->
            <div class="upload-section bg-gray-50 p-6 rounded-xl border border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Upload a New Image</h2>
                <div class="input-group">
                    <label for="image-input" class="text-gray-700">Select an Image to Share:</label>
                    <input type="file" id="image-input" accept="image/*" class="w-full p-2 border border-gray-300 rounded-lg mt-2 cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="upload-btn" class="btn-primary flex items-center justify-center mt-6 w-full" disabled>
                    Upload to the Cloud
                    <span id="upload-spinner" class="loading-spinner hidden"></span>
                </button>
                <div id="message-box" class="message-box hidden" role="alert"></div>
            </div>

            <!-- Display Section -->
            <div class="display-section mt-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Shared Images</h2>
                <div id="image-display-area" class="image-grid">
                    <!-- Images will be loaded here -->
                    <p id="no-images-message" class="col-span-full text-center text-gray-500 text-sm italic">No images uploaded yet. Be the first to share!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase config, app ID, and auth token
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = {};
        try {
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        } catch (e) {
            console.error("Error parsing __firebase_config:", e);
        }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase instances
        let app;
        let db;
        let auth;
        let currentUserId = 'loading...';
        let unsubscribeFromImages = null;

        // DOM elements
        const imageInput = document.getElementById('image-input');
        const uploadBtn = document.getElementById('upload-btn');
        const imageDisplayArea = document.getElementById('image-display-area');
        const noImagesMessage = document.getElementById('no-images-message');
        const messageBox = document.getElementById('message-box');
        const userIdDisplay = document.getElementById('user-id-display');
        const uploadSpinner = document.getElementById('upload-spinner');
        
        // New password-related DOM elements
        const passwordContent = document.getElementById('password-content');
        const passwordInput = document.getElementById('password-input');
        const passwordSubmitBtn = document.getElementById('password-submit-btn');
        const passwordMessage = document.getElementById('password-message');
        const mainContent = document.getElementById('main-content');


        // Configuration for image compression
        const IMAGE_MAX_WIDTH = 800; // Max width for compressed images
        const IMAGE_QUALITY = 0.7;   // Compression quality (0 to 1, 1 being highest)
        // Max allowed size after compression (slightly less than 1MB Firestore limit, Base64 adds ~33% overhead)
        const MAX_UPLOAD_SIZE_BYTES = 900 * 1024;

        /**
         * Displays a message in the message box.
         * @param {string} message The message to display.
         * @param {string} type The type of message (e.g., 'info', 'success', 'warning', 'error').
         */
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000); // Hide after 5 seconds
        }
        
        /**
         * Converts a data URL to a Base64 string without the prefix.
         * @param {string} dataUrl The data URL string.
         * @returns {string} The Base64 portion of the data URL.
         */
        function dataUrlToBase64(dataUrl) {
            return dataUrl.split(',')[1];
        }

        /**
         * Converts an Image File object to a Base64 encoded string.
         * Used internally to load image data for compression.
         * @param {File} imageFile The image file to convert.
         * @returns {Promise<string>} A promise that resolves with the Base64 string.
         */
        function fileToDataURL(imageFile) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(imageFile);
            });
        }

        /**
         * Compresses an image and returns its Base64 representation.
         * Resizes the image if its width exceeds IMAGE_MAX_WIDTH and applies IMAGE_QUALITY.
         * @param {File} imageFile The image file to compress.
         * @returns {Promise<string>} A promise that resolves with the compressed Base64 string.
         */
        async function compressImage(imageFile) {
            return new Promise(async (resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    let width = img.width;
                    let height = img.height;

                    // Calculate new dimensions if image is too wide
                    if (width > IMAGE_MAX_WIDTH) {
                        height = Math.round((height * IMAGE_MAX_WIDTH) / width);
                        width = IMAGE_MAX_WIDTH;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    // Draw image on canvas
                    ctx.drawImage(img, 0, 0, width, height);

                    // Get compressed data URL
                    try {
                        const compressedDataUrl = canvas.toDataURL(imageFile.type, IMAGE_QUALITY);
                        resolve(compressedDataUrl);
                    } catch (error) {
                        reject(new Error("Failed to compress image: " + error.message));
                    }
                };
                img.onerror = () => reject(new Error("Failed to load image for compression."));

                // Load the image source
                try {
                    const dataUrl = await fileToDataURL(imageFile);
                    img.src = dataUrl;
                } catch (error) {
                    reject(new Error("Failed to read image file: " + error.message));
                }
            });
        }
        
        /**
         * Fetches the user's public IP address from a third-party service.
         * @returns {Promise<string>} The user's IP address or a default error string.
         */
        async function getIpAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error("Could not fetch IP address:", error);
                return 'Unknown IP';
            }
        }

        /**
         * Initializes Firebase and sets up authentication listener.
         */
        async function initFirebase() {
            userIdDisplay.textContent = 'Authenticating...';
            uploadBtn.disabled = true; // Disable until authenticated

            if (Object.keys(firebaseConfig).length === 0) {
                showMessage("Firebase configuration is missing or invalid. Please ensure the environment provides __firebase_config.", 'error');
                userIdDisplay.textContent = 'Auth Failed (Config Missing)';
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid; // Store the user ID for session context
                        userIdDisplay.textContent = currentUserId;
                        console.log('User authenticated:', currentUserId);
                        setupRealtimeImageListener(); // Setup listener once authenticated
                        uploadBtn.disabled = false; // Enable button once authenticated
                        showMessage('Authentication successful. You can now upload images!', 'success');
                    } else {
                        // Attempt to sign in anonymously if no user or custom token
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                showMessage('Signed in with custom token.', 'info');
                            } else {
                                await signInAnonymously(auth);
                                showMessage('Signed in anonymously.', 'info');
                            }
                        } catch (error) {
                            console.error('Error signing in:', error);
                            userIdDisplay.textContent = 'Auth Failed (Error)';
                            showMessage('Authentication failed: ' + error.message + '. Images cannot be uploaded.', 'error');
                            uploadBtn.disabled = true; // Keep disabled if auth fails
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessage("Failed to initialize Firebase: " + error.message + ". Images cannot be uploaded.", 'error');
                userIdDisplay.textContent = 'Error Init';
            }
        }

        /**
         * Sets up the real-time listener for images from the public Firestore collection.
         */
        function setupRealtimeImageListener() {
            if (!db) {
                console.log('Cannot set up listener: Firebase not ready.');
                return;
            }

            // Unsubscribe from previous listener if exists to prevent duplicates
            if (unsubscribeFromImages) {
                unsubscribeFromImages();
            }

            // Reference to the PUBLIC images collection
            // All users will write to and read from this single collection.
            const imagesCollectionRef = collection(db, `artifacts/${appId}/public/data/uploaded_images`);

            // Query to get images, ordered by timestamp for most recent first.
            const q = query(imagesCollectionRef, orderBy('timestamp', 'desc')); // Order by timestamp directly

            unsubscribeFromImages = onSnapshot(q, (snapshot) => {
                const images = [];
                snapshot.forEach((doc) => {
                    images.push({ id: doc.id, ...doc.data() });
                });
                displayImages(images);
                console.log("Images updated:", images.length);
            }, (error) => {
                console.error("Error getting real-time images:", error);
                showMessage("Error loading images: " + error.message, 'error');
            });
        }

        /**
         * Displays the fetched images in the UI.
         * @param {Array<Object>} images An array of image objects from Firestore.
         */
        function displayImages(images) {
            imageDisplayArea.innerHTML = ''; // Clear previous images

            if (images.length === 0) {
                noImagesMessage.classList.remove('hidden');
                imageDisplayArea.appendChild(noImagesMessage);
                return;
            } else {
                noImagesMessage.classList.add('hidden');
            }

            images.forEach(img => {
                const imgElement = document.createElement('div');
                imgElement.className = 'image-item';
                imgElement.setAttribute('data-image-data', img.data);
                imgElement.innerHTML = `
                    <div class="image-info"><b>IP Address:</b> ${img.ipAddress || 'N/A'}</div>
                    <img src="${img.data}" alt="${img.name}" loading="lazy">
                    <div class="image-info mt-auto pt-2">${img.name}</div>
                    <button class="btn-secondary w-full mt-4 describe-btn" data-image-id="${img.id}">
                        ✨ Describe Image
                    </button>
                    <div class="description-box hidden"></div>
                `;
                imageDisplayArea.appendChild(imgElement);
            });
        }

        /**
         * Handles the image upload process, now including compression.
         */
        async function handleUpload() {
            // Ensure Firebase is ready and user is authenticated (even anonymously)
            if (!db || !auth || !auth.currentUser) {
                showMessage('Firebase not ready or you are not authenticated. Please wait for initialization.', 'error');
                return;
            }

            const file = imageInput.files[0];
            if (!file) {
                showMessage('Please select an image file to upload.', 'warning');
                return;
            }

            uploadBtn.disabled = true;
            uploadSpinner.classList.remove('hidden');
            uploadBtn.textContent = 'Uploading...';

            try {
                showMessage('Compressing image...', 'info');
                const compressedDataUrl = await compressImage(file);
                const ipAddress = await getIpAddress(); // Fetch IP address here

                // Get size of compressed Base64 string (approximate)
                const compressedSize = Math.round((compressedDataUrl.length - compressedDataUrl.indexOf(',') - 1) * 0.75);

                if (compressedSize > MAX_UPLOAD_SIZE_BYTES) {
                    showMessage(`Compressed image is still too large (${(compressedSize / 1024).toFixed(2)}KB). Max allowed is ${(MAX_UPLOAD_SIZE_BYTES / 1024).toFixed(0)}KB. Please choose a smaller image or one with less detail.`, 'error');
                    return;
                }

                // Create a document in the public collection
                const imageDocRef = doc(collection(db, `artifacts/${appId}/public/data/uploaded_images`));

                await setDoc(imageDocRef, {
                    name: file.name,
                    originalSize: file.size,
                    compressedSize: compressedSize,
                    type: file.type,
                    data: compressedDataUrl,
                    timestamp: Date.now(), // Timestamp for ordering
                    ipAddress: ipAddress // Store the fetched IP address
                });

                showMessage('Image uploaded and shared successfully!', 'success');
                imageInput.value = ''; // Clear the file input
            } catch (error) {
                console.error('Error uploading image:', error);
                showMessage('Error uploading image: ' + error.message, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadSpinner.classList.add('hidden');
                uploadBtn.textContent = 'Upload to the Cloud';
            }
        }
        
        /**
         * Fetches a description of an image using the Gemini API.
         * @param {string} base64Data The Base64 encoded image data.
         * @param {string} mimeType The MIME type of the image (e.g., 'image/png').
         * @returns {Promise<string>} A promise that resolves with the image description.
         */
        async function getGeminiImageDescription(base64Data, mimeType) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [
                        { text: "Describe this image in detail." },
                        { inlineData: { mimeType: mimeType, data: base64Data } }
                    ]
                }]
            };

            let response;
            try {
                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                return text || 'Could not generate a description.';
            } catch (error) {
                console.error("Error fetching Gemini description:", error);
                return `Error: ${error.message}`;
            }
        }

        // Initialize Firebase and set up event listeners when the DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            // Password logic
            passwordSubmitBtn.addEventListener('click', () => {
                const enteredPassword = passwordInput.value;
                
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const currentTimePassword = hours + minutes;
                
                if (enteredPassword === currentTimePassword) {
                    passwordContent.remove(); // Use .remove() to completely delete the password div
                    mainContent.classList.remove('hidden');
                    initFirebase(); // Only initialize Firebase on successful password
                } else {
                    passwordMessage.textContent = 'Incorrect password. Please try again.';
                    passwordMessage.classList.remove('hidden');
                    passwordInput.value = ''; // Clear input
                    setTimeout(() => { passwordMessage.classList.add('hidden'); }, 3000); // Hide error after 3 seconds
                }
            });

            uploadBtn.addEventListener('click', handleUpload);
            
            // Event delegation for dynamically created "Describe" buttons
            imageDisplayArea.addEventListener('click', async (event) => {
                const target = event.target;
                if (target.classList.contains('describe-btn')) {
                    const imageItem = target.closest('.image-item');
                    const imageData = imageItem.getAttribute('data-image-data');
                    const descriptionBox = imageItem.querySelector('.description-box');
                    const imageElement = imageItem.querySelector('img');

                    if (!imageData || !imageElement) {
                        descriptionBox.textContent = "Error: Image data not found.";
                        descriptionBox.classList.remove('hidden');
                        return;
                    }

                    target.disabled = true;
                    target.textContent = 'Analyzing...';
                    descriptionBox.classList.remove('hidden');
                    descriptionBox.textContent = 'Gemini is thinking...';
                    
                    try {
                        const base64Data = dataUrlToBase64(imageData);
                        const mimeType = imageElement.src.split(';')[0].split(':')[1];
                        const description = await getGeminiImageDescription(base64Data, mimeType);
                        descriptionBox.textContent = description;
                    } catch (error) {
                        descriptionBox.textContent = `Error: Failed to get description.`;
                        console.error("Failed to describe image:", error);
                    } finally {
                        target.disabled = false;
                        target.textContent = '✨ Describe Image';
                    }
                }
            });
        });
    </script>
</body>
</html>
