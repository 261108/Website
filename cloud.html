<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Uploader</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 800px;
            margin: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center gap-4">
            <h1 class="text-3xl font-bold text-gray-800">Firestore Image Uploader</h1>
            <p class="text-sm text-gray-500 text-center">Your unique user ID is displayed below. This ID is used to store your images securely in a private collection.</p>
            <p id="userIdDisplay" class="font-mono text-xs p-2 bg-gray-100 rounded-md break-all"></p>

            <div class="w-full flex flex-col items-center gap-4 mt-4">
                <input type="file" id="imageInput" accept="image/*" class="w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100" />
                <button id="uploadButton" disabled class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-full opacity-50 cursor-not-allowed">
                    <span id="buttonText">Upload Image</span>
                </button>
            </div>
            <div id="statusMessage" class="text-sm text-center"></div>
        </div>

        <div id="galleryContainer" class="bg-white rounded-xl shadow-lg p-6 flex flex-col gap-4">
            <h2 class="text-2xl font-bold text-gray-800">Your Images</h2>
            <div id="imageGallery" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                <p id="loadingMessage" class="text-center text-gray-400 col-span-full">Loading images...</p>
            </div>
        </div>

        <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full">
                <h3 class="text-lg font-bold mb-2">Notice</h3>
                <p id="modalMessage" class="text-sm text-gray-600 mb-4"></p>
                <button id="modalClose" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-full">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration and Initialization ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId;

        const imageInput = document.getElementById('imageInput');
        const uploadButton = document.getElementById('uploadButton');
        const statusMessage = document.getElementById('statusMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const imageGallery = document.getElementById('imageGallery');
        const loadingMessage = document.getElementById('loadingMessage');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modalMessage');
        const modalClose = document.getElementById('modalClose');

        // --- UI Utility Functions ---
        const showModal = (message) => {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        };

        const hideModal = () => {
            modal.classList.add('hidden');
        };
        modalClose.addEventListener('click', hideModal);

        // --- Main App Logic ---
        const initApp = async () => {
            try {
                // Initialize Firebase services
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Authenticate the user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Get the user ID and display it
                userId = auth.currentUser.uid;
                userIdDisplay.textContent = `User ID: ${userId}`;

                // Setup the real-time listener for the images
                setupImageListener();

                // Enable the upload button
                uploadButton.disabled = false;
                uploadButton.classList.remove('opacity-50', 'cursor-not-allowed');
                uploadButton.classList.add('bg-blue-600', 'hover:bg-blue-700', 'transition', 'duration-200');

            } catch (error) {
                console.error("Firebase initialization or auth failed:", error);
                showModal("Could not initialize the app. Please check the console for details.");
            }
        };

        const setupImageListener = () => {
            const userImagesPath = `/artifacts/${appId}/users/${userId}/images`;
            const q = query(collection(db, userImagesPath));

            onSnapshot(q, (querySnapshot) => {
                loadingMessage.classList.add('hidden');
                imageGallery.innerHTML = '';
                if (querySnapshot.empty) {
                    imageGallery.innerHTML = `<p class="text-center text-gray-400 col-span-full">No images uploaded yet.</p>`;
                } else {
                    querySnapshot.forEach((doc) => {
                        const imageData = doc.data();
                        const imageContainer = document.createElement('div');
                        imageContainer.className = 'flex flex-col items-center p-2 border border-gray-200 rounded-lg shadow-sm';
                        
                        const img = document.createElement('img');
                        img.src = imageData.base64;
                        img.alt = 'Uploaded Image';
                        img.className = 'w-full h-auto rounded-lg mb-2 object-cover';
                        
                        imageContainer.appendChild(img);
                        imageGallery.appendChild(imageContainer);
                    });
                }
            }, (error) => {
                console.error("Error fetching images:", error);
                showModal("Failed to load images. Please check your internet connection.");
            });
        };

        const uploadImage = async () => {
            const file = imageInput.files[0];
            if (!file) {
                showModal("Please select an image to upload.");
                return;
            }

            // Check file size (Firestore document size limit is 1MB)
            if (file.size > 1024 * 1024) {
                showModal("File is too large! Please select an image smaller than 1MB.");
                return;
            }

            statusMessage.textContent = 'Uploading...';
            uploadButton.disabled = true;

            const reader = new FileReader();
            reader.onload = async (event) => {
                const base64String = event.target.result;

                try {
                    const userImagesPath = `/artifacts/${appId}/users/${userId}/images`;
                    await addDoc(collection(db, userImagesPath), {
                        base64: base64String,
                        timestamp: serverTimestamp(),
                        ownerId: userId
                    });
                    statusMessage.textContent = 'Upload successful!';
                    imageInput.value = ''; // Clear the input
                } catch (error) {
                    console.error("Error uploading image:", error);
                    showModal("Upload failed. Please try again.");
                    statusMessage.textContent = '';
                } finally {
                    uploadButton.disabled = false;
                }
            };
            reader.readAsDataURL(file);
        };

        // --- Event Listeners ---
        uploadButton.addEventListener('click', uploadImage);
        
        // Disable button until a file is selected
        imageInput.addEventListener('change', () => {
            uploadButton.disabled = !imageInput.files[0];
        });

        // Initialize the app on page load
        initApp();
    </script>
</body>
</html>
